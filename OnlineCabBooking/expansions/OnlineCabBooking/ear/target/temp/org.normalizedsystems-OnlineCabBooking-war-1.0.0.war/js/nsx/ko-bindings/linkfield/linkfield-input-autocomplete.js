var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};define(["require","exports","knockout","nsx/model/dataref","nsx/nsx-agent","nsx/util/text-utils","./dropdowns"],(function(e,t,n,i,a,o,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createLinkFieldAutocomplete=void 0;var l=(0,o.translate)("ns.dropdown.empty");function u(e,t,n,i){var a=__assign({},n.autocomplete.finderDetails);return a[n.autocomplete.finderField]=r(e,n),t.busyIcon.style.display="initial",i.find({searchMethod:n.autocomplete.finder,details:a,page:0,rowsPerPage:n.dropdown.maxSize,sortFields:n.dropdown.sortFields}).then((function(e){return t.busyIcon.style.display="none",e}))}function r(e,t){return t.autocomplete.wildcardPrefix?"%".concat(e,"%"):"".concat(e,"%")}t.createLinkFieldAutocomplete=function(e,t){var o=(0,a.createAgent)(t.dataElement),c={},d=function(e,t){var n="data_"+t.dataElement.getElementName()+"_"+Math.round(1e7*Math.random()),i=document.createElement("input");i.setAttribute("list",n),i.type="search",i.style.zIndex="2",i.style.marginBottom="0",i.style.position="absolute",i.style.borderTopRightRadius="0",i.style.borderBottomRightRadius="0",i.placeholder=l(),l.subscribe((function(e){return i.placeholder=e}));var a=document.createElement("select");a.style.zIndex="1",a.style.marginBottom="0",a.style.position="absolute",a.style.paddingLeft="6px",a.tabIndex=-1;var o=document.createElement("datalist");o.id=n;var s=document.createElement("span");s.classList.add("icon-spinner","rotating-icon"),s.style.display="none";var u=document.createElement("div");u.style.position="relative",u.append(i,a,s,o),e.append(u);var r=i.getBoundingClientRect();return a.style.width=r.width+20+2+"px",u.style.height=r.height+"px",{input:i,select:a,datalist:o,busyIcon:s}}(e,t),p="",m=0;function v(){var e=t.value();if(e.id!==m){m=e.id,p="";var n=d.select.namedItem("__selection");if(n&&d.select.removeChild(n),0===e.id)return(0,s.clear)(d.datalist),void(d.input.value="");(function(e,t,n){return new Promise((function(t){n.getProjection(e,"info").then((function(e){e.success&&t(e.value)}))}))})(e,0,o).then((function(e){var n=(0,s.getLabel)(e,t);d.input.setCustomValidity(""),(0,s.clear)(d.datalist),b([e],c);var i=(0,s.createOption)(e,n,t);i.setAttribute("name","__selection"),d.select.prepend(i),d.select.value=n,d.input.value=n,p=n}))}}function f(){var e=y(d.input.value);e?t.autocomplete.autocommit&&g(e):t.dropdown.required||""!==d.input.value?d.input.setCustomValidity(l()):d.input.setCustomValidity("")}function h(){var e=y(d.input.value);e?g(e):(d.input.setCustomValidity(l()),d.input.reportValidity())}function y(e){return e?c[e]:t.dropdown.required?null:(0,i.createNullDataRef)()}function g(e){d.input.setCustomValidity(""),t.value(e)}function b(e,n){e.forEach((function(e){var i=(0,s.getQueryValue)(e,t),a=(0,s.getLabel)(e,t);n[i]=e.dataRef,n[a]=e.dataRef}))}function E(){d.select.style.zIndex="3",!0}function L(){d.select.style.zIndex="1",d.select.blur(),!1}d.input.addEventListener("change",h),d.input.addEventListener("search",h),d.input.addEventListener("keyup",(function(n){t.autocomplete.autocommit||"Enter"!==n.key?function(){var n,i=d.input.value;if(i!==p){if(i===s.MORE_VALUE){var a=new CustomEvent("show-picklist",{detail:{finder:t.autocomplete.finder,finderDetails:(n={},n[t.autocomplete.finderField]=r(p,t),n)}});return e.dispatchEvent(a),void(d.input.value=p)}""===i&&f(),p=i,!t.autocomplete.minimumLength||i.length>=t.autocomplete.minimumLength?u(i,d,t,o).then((function(e){e.success&&d.input.value===i&&((0,s.setAutocompleteOptions)({container:d.datalist,list:e.list,totalNbItems:e.totalNumberOfItems,searchString:i,params:t}),b(e.list,c),f())})):(0,s.clear)(d.datalist)}}():h()})),d.select.addEventListener("mousedown",E,!0),d.select.addEventListener("change",L,!0),document.addEventListener("click",(function(){d.select!==document.activeElement&&L()})),d.select.addEventListener("blur",L),d.select.addEventListener("change",(function(){var n=d.select.value;if(t.dropdown.includeMore&&n===s.MORE_VALUE){var i=new CustomEvent("show-picklist");e.dispatchEvent(i)}else d.input.value=n,h(),d.input.focus(),L()}));var w=t.value.subscribe(v);n.utils.domNodeDisposal.addDisposeCallback(e,(function(){w.dispose()})),u("",d,t,o).then((function(e){e.success&&((0,s.setSelectOptions)({container:d.select,list:e.list,totalNbItems:e.totalNumberOfItems,valueFunction:function(e){return(0,s.getLabel)(e,t)},params:t}),b(e.list,c)),t.value().id&&v()}))}}));