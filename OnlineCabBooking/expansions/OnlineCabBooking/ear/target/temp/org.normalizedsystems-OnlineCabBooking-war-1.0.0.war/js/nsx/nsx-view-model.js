"use strict";define(["knockout","nsx/nsx-application","nsx/nsx-dialog","nsx/nsx-list-model","nsx/nsx-profile-access","nsx/nsx-find-model","nsx/nsx-finder-selection-model","nsx/nsx-forms","nsx/nsx-translation","nsx/nsx-data","nsx/nsx-utils","nsx/nsx-meta"],(function(e,n,t,i,r,a,o,s,d,c,l,f){function u(e,n){n=n||{};var t,i=0;if($.isArray(e))for(t=e;i<t.length;i++)n[t[i]]=!0;else n[e]=!0;return n}function g(e,n){n=n||{};var t,i=0;if($.isArray(e))for(t=e;i<t.length;i++)n[t[i]]=!1;else n[e]=!1;return n}function m(e,n){n={};var t,i=0;if($.isArray(e))for(t=e;i<t.length;i++)n[t[i]]=!0;else n[e]=!0;return n}function h(l,h){var v,b={},p={selectRow:void 0,deselectRow:void 0};if(h.listModel)v=h.listModel;else{var O=function(){var e=h&&h.dataModel;if(e)return e;var n={};h.projection&&(n.projection=h.projection);return a.createDataModel(l,n)}();v=i.createListModel(O,p,h&&h.listOptions)}var M,I,F=!(h&&h.dataModel),P=void 0,y=e.observable(!1),C=e.observable(!1),x=h.finders||e.observableArray();if(F){var w={setFinder:function(e,n){b.searching.setFinder(e,n)},resetFinder:function(){b.searching.resetFinder()},finders:x};P=o.createFinderSelectionModel(l,w)}function D(e,n){s.viewDetail(e,n,b.viewInteraction)}function A(e){D(n.getElement(e.componentName,e.classPrefix),e.id)}function j(e,n,t,i){var r;switch(n){case"create":r=t;break;case"modify":r=i}return r&&r[e]}return b.manipulation={createItem:function(){var e=b.formInteraction,n=e.defaultsOnCreate,t=n?n(l):{};s.createDetail(l,t,e)},modifyItem:function(){var e=b.selectedItem();s.modifyDetail(l,e.id,b.formInteraction)},deleteItem:function(){var e=b.selectedItem(),n=b.selectedItems();n.length>1?d.getTranslation("ns.areYouSureToDeleteMultipleItems",(function(e){if(e=e.replace("{count}",n.length),confirm(e)){var t=n.map((function(e){return{id:e.id}}));c.deleteMultipleDetails(l,t,(function(e){if(e.success)b.paging.reloadPage();else{var n=e.errorMessages.join("\n");alert("Could not delete the selected items:\n"+n)}}))}})):d.getTranslation("ns.areYouSureToDeleteFollowingObject",(function(n){n+=":\n\n"+e.name,confirm(n)&&c.deleteDetails(l,e.id,(function(e){if(e.success)b.paging.reloadPage();else{var n=e.errorMessages.join("\n");alert("Could not delete the selected item:\n"+n)}}))}))},viewItem:function(){var e=b.selectedItem();D(l,e.id)}},b.searching={finderSelectionModel:P,hasFinderSelection:F,isFinderVisible:C,toggleFinder:function(){var e=C();C(!e)},isFinderActive:y,setFinder:function(e,n){var t;t="string"==typeof e?e:e.name,v.setFinder(t,n),b.gotoFirstPage(),y(!0)},resetFinder:function(){C(!1),v.resetFinder(),b.gotoFirstPage(),y(!1)},showFinder:function(){C(!0)}},b.paging={hasMultiplePages:v.hasMultiplePages,hasPreviousPage:v.hasPreviousPage,hasNextPage:v.hasNextPage,previousPage:v.previousPage,nextPage:v.nextPage,currentPage:v.currentPage,numberOfPages:v.numberOfPages,totalNumberOfItems:v.totalNumberOfItems,reloadPage:v.reloadPage,gotoFirstPage:v.gotoFirstPage,gotoLastPage:v.gotoLastPage,gotoPage:v.gotoPage,userPage:void 0},b.paging.userPage=(M=b.paging,I=e.observable(M.currentPage()),M.currentPage.subscribe((function(e){I(e)})),e.computed({read:I,write:function(e){if(!isNaN(e)){var n=parseInt(e);if(n>=1&&n<=M.numberOfPages())return I(n),void M.gotoPage(n-1)}I.notifySubscribers()}})),b.accessRights={canView:e.observable(!0),canCreate:e.observable(!1),canModify:e.observable(!1),canDelete:e.observable(!1)},b.viewing={viewItem:A},b.refresh=function(){b.paging.reloadPage()},b.formInteraction={edit:t.showDialog,afterSubmit:function(){return b.refresh()},defaultsOnCreate:void 0,isFieldVisible:function(e,n){return!j(e,n,b.formInteraction.hideOnCreate,b.formInteraction.hideOnModify)},isFieldEnabled:function(e,n){return!j(e,n,b.formInteraction.disableOnCreate,b.formInteraction.disableOnModify)},hideOnCreate:void 0,hideOnModify:void 0,disableOnCreate:void 0,disableOnModify:void 0,templateName:void 0},b.viewInteraction={view:t.showDialog,viewReference:A},b.sorting=v.sorting,b.updateAccessRights=function(n){!function(n,t){var i,r,a,o=["canView","canCreate","canModify","canDelete"],s=t;for(n.canModify(s.canEdit),n.canCreate(s.canEdit),i=0;i<o.length;i++)a=void 0,void 0!==(a=s[r=o[i]])&&(e.isWriteableObservable(n[r])?n[r](a):n[r]=a)}(b.accessRights,n)},b.listInteraction=p,b.listModel=v,b.setDataModel=function(e){b.listModel.setDataModel(e)},b.selectedItem=function(){return v.selectedItem()},b.selectedItems=function(){return v.selectedItems()},b.selection=v.selectedItem,b.hasSelection=e.computed((function(){return!!b.selectedItem()})),b.gotoFirstPage=function(){return v.gotoFirstPage()},b.gotoLastPage=function(){return v.gotoLastPage()},b.hideOnCreate=function(e){b.formInteraction.hideOnCreate=u(e,b.formInteraction.hideOnCreate)},b.hideOnModify=function(e){b.formInteraction.hideOnModify=u(e,b.formInteraction.hideOnModify)},b.disableOnCreate=function(e){b.formInteraction.disableOnCreate=u(e,b.formInteraction.disableOnCreate)},b.disableOnModify=function(e){b.formInteraction.disableOnModify=u(e,b.formInteraction.disableOnModify)},b.showOnCreate=function(e){b.formInteraction.hideOnCreate=g(e,b.formInteraction.hideOnCreate)},b.showOnModify=function(e){b.formInteraction.hideOnModify=g(e,b.formInteraction.hideOnModify)},b.enableOnCreate=function(e){b.formInteraction.disableOnCreate=g(e,b.formInteraction.disableOnCreate)},b.enableOnModify=function(e){b.formInteraction.disableOnModify=g(e,b.formInteraction.disableOnModify)},b.setHideOnCreate=function(e){b.formInteraction.hideOnCreate=m(e,b.formInteraction.hideOnCreate)},b.setHideOnModify=function(e){b.formInteraction.hideOnModify=m(e,b.formInteraction.hideOnModify)},b.setDisableOnCreate=function(e){b.formInteraction.disableOnCreate=m(e,b.formInteraction.disableOnCreate)},b.setDisableOnModify=function(e){b.formInteraction.disableOnModify=m(e,b.formInteraction.disableOnModify)},r.getAccessRightsForElement(l,(function(e){var n=e.value;b.updateAccessRights(n),h&&h.onModelComplete&&h.onModelComplete()})),h.finders||f.getAndFilterFinders({element:l,finders:x,accept:f.rejectFindAllFinder}),b}return{createViewModel:h,createDependentViewModel:function(n){var t,i,r=e.observableArray(),s=a.createDependentDataModel({element:n.element,parentField:n.parentField,projection:n.projection,searchMethod:n.searchMethod,searchDetails:n.searchDefaults}),d=h(n.element,{dataModel:s,projection:n.projection,finders:r});d.setParent=function(e){i=e,s.setParent(i)},d.getParent=function(){return i},n.defaultsOnCreate,n.parent&&e.isObservable(n.parent)&&n.parent.subscribe((function(e){d.setParent(e),d.gotoFirstPage()})),n.parentModel&&n.parentModel.selection.subscribe((function(e){d.setParent(e),d.gotoFirstPage()})),t=d.refresh,d.refresh=function(){t(),n.parentModel&&n.parentModel.refresh(),n.refresh&&n.refresh()};var c=d.searching.setFinder;return d.searching.setFinder=function(e,t){var r=$.extend({},t);return r[n.parentField]=i,c(e,r)},d.searching.finderSelectionModel=o.createFinderSelectionModel(n.element,function(e,n){return{setFinder:e.searching.setFinder,resetFinder:e.searching.resetFinder,finders:r,hiddenFields:[n.parentField]}}(d,n)),d.searching.hasFinderSelection=e.computed((function(){return r().length>0})),function(e,n){var t=n.defaultsOnCreate;e.formInteraction.defaultsOnCreate=function(){var i;return i=t?$.isFunction(t)?t():t:{},n.parentField&&(i[n.parentField]=l.createDataRef(n.parentElement,e.getParent())),i}}(d,n),n.parentField&&function(e,n){var t=n.element.getElementName()+"."+n.parentField;e.disableOnCreate(t),e.disableOnModify(t)}(d,n),function(e){var n=l.firstToUpperCase(e.parentField)+"Eq";f.getAndFilterFinders({element:e.element,finders:r,accept:function(e){if(e.findAll)return!1;var t=e.fieldExpressions;return t.length>=2&&$.inArray(n,t)>=0}})}(n),d}}}));