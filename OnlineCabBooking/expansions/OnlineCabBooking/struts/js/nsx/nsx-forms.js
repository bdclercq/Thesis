"use strict";define(["require","knockout","nsx/nsx-detail","nsx/nsx-data","nsx/nsx-utils","nsx/nsx-translation","nsx/nsx-actions","nsx/nsx-struts-helper"],(function(e,n,t,r,a,i,o,s){function l(e,n,t){r.getDetails(e,n,(function(r){r.success?t(r.value):alert("Could not find an instance of '"+e.getElementName()+"' with id '"+n+"'")}))}function c(e){var t=n.observable();return i.getTranslation(e.getElementName(),(function(e){e=a.firstToUpperCase(e),t(e)})),t}function f(e,a,i,l){t.getForm(e,i.templateName,(function(t){var f=n.observableArray();function u(e,n){var r=t.mapper.viewModelToJS(e.detailModel);if(i.validateForm&&!i.validateForm(e,r))return;var a=r._hasFileUpload;if(delete r._hasFileUpload,a){var l,c;for(var f in r)r[f]instanceof File&&(l=r[f],c=f);if(l)delete r[c],function(e,n,t){var r=e.getElementName()+"Details",a={};a[r]=n;var i=s.mapToFormData(a);i.append("uploadData",t);var l=o.getElementUrl(e,"saveDetails-json");return jQuery.ajax({type:"POST",url:l,data:i,processData:!1,contentType:!1})}(t.element,r,l).done((function(e){v(e,n)}));else d(t.element,r,n)}else d(t.element,r,n)}function d(e,n,t){var a=r.saveDetails(e,n);a.done((function(e){v(e,t)})),a.fail((function(e){m(e.responseJSON)}))}function v(e,n){e.success?(n(e),i.afterSubmit(b,e)):m(e)}function m(e){var n;!function(e){f.removeAll();for(var n=0;n<e.length;n++)f.push(e[n])}(e.errorMessages),n=e.fieldErrorMap,$.each(p,(function(e){var n=p[e];n&&n.errorMessages&&(n.errorMessages.removeAll(),n.hasErrors(!1))})),$.each(n,(function(e,n){var t=e.split("."),r=t[2]||t[1]||t[0],a=p[r];a&&a.errorMessages&&(a.hasErrors(!0),$.each(n,(function(e,n){a.errorMessages.push(n)})))}))}var p=t.mapper.jsToViewModel(a);!function(e){$.each(e,(function(e,t){n.isObservable(t)&&(t.errorMessages=n.observableArray(),t.hasErrors=n.observable(!1))}))}(p);var b={title:c(e),content:t.template,contentModel:{detailModel:p,isFieldVisible:i.isFieldVisible||function(e,n){return!0},isFieldEnabled:i.isFieldEnabled||function(e,n){return!0},editMode:l},confirm:function(e,n){i.confirmEdit?i.confirmEdit({viewModel:e,successCallback:n}):u(e,n)},errorMessages:f};i.edit(b)}))}return{createDetail:function(e,n,t){f(e,n||{},t,"create")},modifyDetail:function(e,n,t){l(e,n,(function(n){f(e,n,t,"modify")}))},viewDetail:function(e,n,r){t.getView(e,(function(t){l(e,n,(function(n){var a={title:c(e),content:t.template,contentModel:n,showReference:r.viewReference,editReference:r.editReference};r.view(a)}))}))}}}));