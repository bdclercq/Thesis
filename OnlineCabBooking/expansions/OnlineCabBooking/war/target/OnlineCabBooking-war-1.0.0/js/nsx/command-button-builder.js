define(["require","exports","knockout","jquery","nsx/config/access-rights","nsx/injectors/popup","nsx/triggers","nsx/notification/nsx-notification","nsx/action/perform-command-action","nsx/nsx-translation","nsx/nsx-dialog","nsx/util/widget-utils"],(function(e,t,n,r,i,o,u,s,c,a,f,g){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineDropdownButton=t.defineActionButton=t.defineFormButton=t.ButtonType=void 0;var l,d,m=i.getAccessRightsController(),p=u.when;function v(e){var t={data:e.data,layoutConfig:{targets:{hidden:!0}}};"target"in e.instance&&(t.target=e.instance.target);var n=e.form.defineCommandForm(t,{resetOn:e.trigger});return function(e,t){o.definePopup({title:t.popupTitle||t.title||x(t.name),view:t.view,viewModel:e,trigger:t.trigger},{onConfirm:e.submit,closeOn:e.success})}(n,e),I(n.success,n.messages,e),n}function b(e,t){e.subscribe((function(){var e=n.observable(!0);setTimeout((function(){if(e()){var t=f.unclosableDialog(l,{title:"Command In Progress"});e.subscribe((function(e){e||t.close()})),e()||t.close()}}),1e3),t.forEach((function(t){return p(t).thenDo((function(){return e(!1)}))}))}))}function h(e){var t=c.definePerformCommandAction({instance:e.instance,commandName:e.name,trigger:e.trigger,element:e.element},{});return I(t.successEvent,t.messages,e),function(e){p(e.errorEvent).thenDo((function(){var t=e.errorMessage(),n=e.fieldErrorMap(),r=Object.keys(n).length,i=0;0!=r&&(t+="\n\nSpecified reasons:"),Object.keys(n).forEach((function(e){a.getTranslation(n[e],(function(e){t+="\n* "+e,++i===r&&s.popupError(t)}))})),0==r&&s.popupError(t)}))}(t),t}function N(e,t){var i=function(e,t){switch(t){case d.NO_INSTANCE:return{};case d.MULTI_INSTANCE:return{targets:e.selectedItems};case d.SINGLE_INSTANCE:default:return{target:e.selection}}}(e,t.buttonType);return r.extend({},t,{data:n.pureComputed((function(){return r.extend(t.data,i)})),instance:i,trigger:u.defineTrigger(),visibilityCheck:T(e,t.buttonType)})}function T(e,t){switch(t){case d.NO_INSTANCE:return n.observable(!0);case d.MULTI_INSTANCE:return n.pureComputed((function(){return!!e.selectedItems&&e.selectedItems().length>0}));case d.SINGLE_INSTANCE:default:return(0,g.isDataRefDefined)(e.selection)}}function C(e,t){return e.defineButton(E(t))}function E(e){var t,r,o=(t=e.element,r=e.name,m.requestRight({element:t,requestedRight:i.Right.ACTION,target:r}));return{icon:e.icon,label:e.buttonTitle||e.title||x(e.name),shortcut:e.shortcut,trigger:e.trigger,visible:n.pureComputed((function(){return o.approved()&&e.visibilityCheck()&&(!e.visible||e.visible())}))}}function I(e,t,n){n.updateTrigger&&p(e).thenTrigger(n.updateTrigger),p(e).thenDo((function(){var e=n.successMessage||x(n.name)+" successful.",r=t();r&&r.length>0&&(e+="\n- ",e+=r.join("\n- ")),s.popupInfo(e)}))}function x(e){var t=e.replace(/[a-z][A-Z]/g,(function(e){return e[0]+" "+e[1]}));return t[0].toUpperCase()+t.substring(1)}e(["text!html/nsx/bootstrap/inProgressCommand.html"],(function(e){l=e})),function(e){e.NO_INSTANCE="no instance",e.SINGLE_INSTANCE="single instance",e.MULTI_INSTANCE="multi instance"}(d=t.ButtonType||(t.ButtonType={})),t.defineFormButton=function(e,t,n){var r=N(t,n);C(e,r);var i=v(r);return b(i.submit,[i.complete]),i},t.defineActionButton=function(e,t,n){var r=N(t,n);C(e,r);var i=h(r);return b(r.trigger,[i.completeEvent]),i},t.defineDropdownButton=function(e,t,n){var r=(n.actionButtons?n.actionButtons:[]).map((function(e){return N(t,e)}));r.forEach((function(e){return h(e)}));var i=(n.formButtons?n.formButtons:[]).map((function(e){return N(t,e)}));i.forEach((function(e){return v(e)}));var o=r;return o=o.concat(i),e.defineDropdownButton({buttons:o.map((function(e){return E(e)})),label:n.title})}}));